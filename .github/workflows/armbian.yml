name: Build Armbian (Multi-Kernel)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        branch: [legacy, current, edge]
    name: Build ${{ matrix.branch }} kernel

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git gcc g++ build-essential \
            bc libncurses5-dev libssl-dev bison flex \
            libz-dev libncurses-dev \
            qemu-user-static binfmt-support debootstrap \
            device-tree-compiler python3 python3-distutils \
            python3-apt libglib2.0-dev

      - name: Build Armbian (${{ matrix.branch }})
        run: |
          ./compile.sh BOARD=rockchip64 BRANCH=${{ matrix.branch }} \
            RELEASE=bookworm BUILD_DESKTOP=no KERNEL_CONFIGURE=no

      - name: Upload artifact (${{ matrix.branch }})
        uses: actions/upload-artifact@v4
        with:
          name: armbian-image-${{ matrix.branch }}
          path: output/images/*.img
          compression-level: 9
          if-no-files-found: error
